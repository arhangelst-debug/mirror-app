<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ó–µ—Ä–∫–∞–ª–æ ‚Äî Evalite</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root {
    --dark: #52505A;
    --dark-deep: #3a3840;
    --silver-1: #C5C4CB;
    --silver-2: #EBEBED;
    --white: #FFFFFF;
    --blue: #2FB7EB;
    --red: #DB0D20;
    --teal: #00ADA6;
    --purple: #854999;
    --bg: #F8F8FA;
    --radius: 16px;
    --transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Space Grotesk', sans-serif;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
    min-height: 100dvh;
    overflow-x: hidden;
    position: relative;
  }

  /* ‚îÄ‚îÄ Decorative background blobs ‚îÄ‚îÄ */
  .bg-blobs {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(70px);
    opacity: 0.12;
    animation: blobDrift 12s ease-in-out infinite alternate;
  }
  .blob-1 { width: 340px; height: 340px; background: var(--blue);   top: -80px;  right: -60px; animation-delay: 0s; }
  .blob-2 { width: 260px; height: 260px; background: var(--purple); bottom: 10%; left: -80px;  animation-delay: -4s; }
  .blob-3 { width: 200px; height: 200px; background: var(--teal);   top: 45%;    right: -40px; animation-delay: -8s; }
  @keyframes blobDrift {
    from { transform: translate(0,0) scale(1); }
    to   { transform: translate(20px, 30px) scale(1.08); }
  }

  /* ‚îÄ‚îÄ App wrapper ‚îÄ‚îÄ */
  #app {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 20px 24px 0;
    opacity: 0;
    animation: fadeDown 0.6s 0.1s ease forwards;
  }
  .logo-eye {
    width: 36px;
    height: 36px;
    flex-shrink: 0;
  }
  .logo-text {
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.18em;
    color: var(--dark);
    text-transform: uppercase;
  }
  .logo-sub {
    font-size: 9px;
    font-weight: 400;
    letter-spacing: 0.2em;
    color: var(--silver-1);
    text-transform: uppercase;
    display: block;
  }

  /* ‚îÄ‚îÄ Screens ‚îÄ‚îÄ */
  .screen {
    display: none;
    flex-direction: column;
    flex: 1;
    padding: 0 24px 32px;
  }
  .screen.active { display: flex; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WELCOME SCREEN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-welcome {
    justify-content: center;
    gap: 0;
  }

  .welcome-emblem {
    display: flex;
    justify-content: center;
    margin: 36px 0 32px;
    animation: scaleIn 0.7s 0.2s ease both;
  }
  .emblem-ring {
    position: relative;
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .emblem-orbit {
    position: absolute;
    inset: 0;
    border: 1.5px solid var(--dark);
    border-radius: 50%;
    animation: spinSlow 20s linear infinite;
  }
  .emblem-orbit::before {
    content: '';
    position: absolute;
    width: 6px; height: 6px;
    background: var(--blue);
    border-radius: 50%;
    top: -3px;
    left: 50%;
    transform: translateX(-50%);
  }
  .emblem-dots-ring {
    position: absolute;
    inset: 8px;
    border: 1px dashed var(--silver-1);
    border-radius: 50%;
    animation: spinSlow 30s linear infinite reverse;
  }
  .emblem-inner {
    width: 54px;
    height: 36px;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .emblem-oval {
    width: 54px;
    height: 36px;
    border: 1.5px solid var(--dark);
    border-radius: 50%;
    position: absolute;
  }
  .emblem-pupil {
    width: 18px;
    height: 18px;
    background: var(--dark);
    border-radius: 50%;
    animation: pupilBreath 4s ease-in-out infinite;
  }
  @keyframes spinSlow { to { transform: rotate(360deg); } }
  @keyframes pupilBreath {
    0%,100% { transform: scale(1); }
    50% { transform: scale(0.85); }
  }

  .welcome-title {
    font-size: 42px;
    font-weight: 300;
    letter-spacing: 0.08em;
    line-height: 1.1;
    text-align: center;
    text-transform: uppercase;
    margin-bottom: 12px;
    animation: fadeUp 0.6s 0.35s ease both;
  }
  .welcome-title span { font-weight: 300; }

  .welcome-desc {
    font-size: 14px;
    font-weight: 300;
    line-height: 1.65;
    color: #7a7880;
    text-align: center;
    max-width: 300px;
    margin: 0 auto 36px;
    animation: fadeUp 0.6s 0.45s ease both;
  }

  .stats-row {
    display: flex;
    gap: 12px;
    margin-bottom: 36px;
    animation: fadeUp 0.6s 0.55s ease both;
  }
  .stat-card {
    flex: 1;
    background: white;
    border: 1px solid var(--silver-2);
    border-radius: var(--radius);
    padding: 14px 10px;
    text-align: center;
  }
  .stat-card .num {
    font-size: 22px;
    font-weight: 700;
    color: var(--dark);
    display: block;
  }
  .stat-card .lbl {
    font-size: 10px;
    font-weight: 400;
    letter-spacing: 0.08em;
    color: var(--silver-1);
    text-transform: uppercase;
    margin-top: 2px;
    display: block;
  }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn-primary {
    width: 100%;
    padding: 17px 24px;
    background: var(--dark);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: var(--transition);
    animation: fadeUp 0.6s 0.65s ease both;
    position: relative;
    overflow: hidden;
  }
  .btn-primary::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, transparent 60%);
  }
  .btn-primary:active { transform: scale(0.98); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     QUESTION SCREEN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-question {
    padding-top: 28px;
  }

  .progress-bar {
    height: 2px;
    background: var(--silver-2);
    border-radius: 2px;
    margin-bottom: 32px;
    overflow: hidden;
    animation: fadeIn 0.4s ease both;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--blue), var(--teal));
    border-radius: 2px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .q-counter {
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.15em;
    color: var(--silver-1);
    text-transform: uppercase;
    margin-bottom: 16px;
    animation: fadeIn 0.4s ease both;
  }

  .q-text {
    font-size: 22px;
    font-weight: 400;
    line-height: 1.35;
    letter-spacing: -0.01em;
    color: var(--dark);
    margin-bottom: 32px;
    min-height: 80px;
    animation: fadeUp 0.4s ease both;
  }

  .options-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
    animation: fadeUp 0.4s 0.1s ease both;
  }

  .option-btn {
    background: white;
    border: 1.5px solid var(--silver-2);
    border-radius: var(--radius);
    padding: 16px 18px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 14px;
    font-weight: 400;
    line-height: 1.4;
    color: var(--dark);
    cursor: pointer;
    text-align: left;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative;
    overflow: hidden;
  }
  .option-btn::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 1.5px solid var(--silver-2);
    border-radius: 50%;
    flex-shrink: 0;
    transition: var(--transition);
  }
  .option-btn.selected {
    border-color: var(--dark);
    background: var(--dark);
    color: white;
  }
  .option-btn.selected::before {
    border-color: white;
    background: white;
    box-shadow: inset 0 0 0 4px var(--dark);
  }
  .option-btn:active:not(.selected) {
    border-color: var(--silver-1);
    background: var(--silver-2);
  }

  .btn-next {
    margin-top: 20px;
    width: 100%;
    padding: 16px 24px;
    background: var(--dark);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: var(--transition);
    opacity: 0;
    transform: translateY(8px);
  }
  .btn-next.visible {
    opacity: 1;
    transform: translateY(0);
    transition: var(--transition);
  }
  .btn-next:active { transform: scale(0.98); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOADING SCREEN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-loading {
    align-items: center;
    justify-content: center;
    gap: 32px;
    text-align: center;
  }

  .loader-eye {
    position: relative;
    width: 90px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .loader-oval {
    width: 90px;
    height: 60px;
    border: 2px solid var(--dark);
    border-radius: 50%;
    position: absolute;
  }
  .loader-pupil {
    width: 28px;
    height: 28px;
    background: var(--dark);
    border-radius: 50%;
    animation: pupilScan 2s ease-in-out infinite;
  }
  @keyframes pupilScan {
    0%,100% { transform: translateX(-12px); opacity: 0.4; }
    50% { transform: translateX(12px); opacity: 1; }
  }
  .loader-rings {
    position: absolute;
    inset: -20px;
  }
  .loader-ring {
    position: absolute;
    border-radius: 50%;
    border: 1px solid;
    opacity: 0;
    animation: ringPulse 2.4s ease-out infinite;
  }
  .loader-ring:nth-child(1) { inset: 10px; border-color: var(--blue);   animation-delay: 0s; }
  .loader-ring:nth-child(2) { inset: 4px;  border-color: var(--teal);   animation-delay: 0.4s; }
  .loader-ring:nth-child(3) { inset: -2px; border-color: var(--purple); animation-delay: 0.8s; }
  @keyframes ringPulse {
    0%   { opacity: 0; transform: scale(0.8); }
    30%  { opacity: 0.5; }
    100% { opacity: 0; transform: scale(1.2); }
  }

  .loading-title {
    font-size: 20px;
    font-weight: 400;
    color: var(--dark);
  }
  .loading-sub {
    font-size: 13px;
    font-weight: 300;
    color: var(--silver-1);
    line-height: 1.6;
    max-width: 240px;
  }

  .loading-steps {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    max-width: 280px;
  }
  .loading-step {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
    font-weight: 400;
    color: var(--silver-1);
    transition: color 0.3s;
  }
  .loading-step.done { color: var(--dark); }
  .step-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--silver-2);
    flex-shrink: 0;
    transition: background 0.3s;
  }
  .loading-step.done .step-dot { background: var(--teal); }
  .loading-step.active .step-dot {
    background: var(--blue);
    animation: stepPulse 0.8s ease-in-out infinite;
  }
  .loading-step.active { color: var(--blue); }
  @keyframes stepPulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     RESULT SCREEN
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #screen-result {
    padding-top: 28px;
  }

  .result-label {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.2em;
    color: var(--silver-1);
    text-transform: uppercase;
    margin-bottom: 10px;
    animation: fadeIn 0.5s ease both;
  }

  .result-title {
    font-size: 28px;
    font-weight: 600;
    letter-spacing: -0.02em;
    color: var(--dark);
    margin-bottom: 24px;
    animation: fadeDown 0.5s 0.1s ease both;
  }

  .result-card {
    background: white;
    border: 1px solid var(--silver-2);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    animation: fadeUp 0.5s 0.2s ease both;
  }
  .result-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--blue), var(--teal), var(--purple));
  }

  .result-text {
    font-size: 15px;
    font-weight: 300;
    line-height: 1.7;
    color: var(--dark);
  }

  .result-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 20px;
    animation: fadeUp 0.5s 0.3s ease both;
  }
  .tag {
    padding: 6px 14px;
    border-radius: 40px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .tag-blue   { background: rgba(47,183,235,0.1); color: #1a9ac7; }
  .tag-teal   { background: rgba(0,173,166,0.1);  color: #007a75; }
  .tag-purple { background: rgba(133,73,153,0.1); color: #6b3380; }
  .tag-red    { background: rgba(219,13,32,0.1);  color: #b00d1a; }

  .btn-done {
    margin-top: 8px;
    width: 100%;
    padding: 17px 24px;
    background: var(--dark);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-family: 'Space Grotesk', sans-serif;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    transition: var(--transition);
    animation: fadeUp 0.5s 0.5s ease both;
  }
  .btn-done:active { transform: scale(0.98); }

  .result-footer {
    text-align: center;
    font-size: 11px;
    font-weight: 300;
    color: var(--silver-1);
    margin-top: 12px;
    letter-spacing: 0.05em;
    animation: fadeIn 0.5s 0.7s ease both;
  }

  /* ‚îÄ‚îÄ Error state ‚îÄ‚îÄ */
  .error-card {
    background: rgba(219,13,32,0.05);
    border: 1px solid rgba(219,13,32,0.2);
    border-radius: var(--radius);
    padding: 20px;
    text-align: center;
    animation: fadeUp 0.4s ease both;
  }
  .error-card p { font-size: 14px; color: #b00d1a; line-height: 1.5; }

  /* ‚îÄ‚îÄ Keyframes ‚îÄ‚îÄ */
  @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
  @keyframes fadeUp  { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
  @keyframes fadeDown{ from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
  @keyframes scaleIn { from{opacity:0;transform:scale(0.8)} to{opacity:1;transform:scale(1)} }

  /* ‚îÄ‚îÄ Screen transition ‚îÄ‚îÄ */
  .screen { animation: fadeIn 0.3s ease; }
</style>
</head>
<body>

<div class="bg-blobs">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
</div>

<div id="app">

  <!-- HEADER -->
  <header class="header">
    <svg class="logo-eye" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
      <ellipse cx="18" cy="18" rx="16" ry="10.5" stroke="#52505A" stroke-width="1.5"/>
      <circle cx="18" cy="18" r="6" fill="#52505A"/>
    </svg>
    <div>
      <span class="logo-text">Evalite</span>
      <span class="logo-sub">Superfood</span>
    </div>
  </header>

  <!-- WELCOME SCREEN -->
  <div id="screen-welcome" class="screen active">
    <div class="welcome-emblem">
      <div class="emblem-ring">
        <div class="emblem-orbit"></div>
        <div class="emblem-dots-ring"></div>
        <div class="emblem-inner">
          <div class="emblem-oval"></div>
          <div class="emblem-pupil"></div>
        </div>
      </div>
    </div>

    <h1 class="welcome-title">–ó–µ—Ä–∫–∞–ª–æ</h1>
    <p class="welcome-desc">–ö–æ—Ä–æ—Ç–∫–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤–Ω—É—Ç—Ä—å. –¢—ã —É–≤–∏–¥–∏—à—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–ø—Ä–∞–≤–ª—è—é—Ç —Ç–≤–æ–∏–º–∏ —Ä–µ—à–µ–Ω–∏—è–º–∏.</p>

    <div class="stats-row">
      <div class="stat-card">
        <span class="num">10</span>
        <span class="lbl">–≤–æ–ø—Ä–æ—Å–æ–≤</span>
      </div>
      <div class="stat-card">
        <span class="num">5</span>
        <span class="lbl">–º–∏–Ω—É—Ç</span>
      </div>
      <div class="stat-card">
        <span class="num">‚àû</span>
        <span class="lbl">–∏–Ω—Å–∞–π—Ç–æ–≤</span>
      </div>
    </div>

    <button class="btn-primary" onclick="startTest()">–ù–∞—á–∞—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</button>
  </div>

  <!-- QUESTION SCREEN -->
  <div id="screen-question" class="screen">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
    <div class="q-counter" id="qCounter">–í–æ–ø—Ä–æ—Å 1 –∏–∑ 10</div>
    <div class="q-text" id="qText"></div>
    <div class="options-list" id="optionsList"></div>
    <button class="btn-next" id="btnNext" onclick="nextQuestion()">–î–∞–ª–µ–µ</button>
  </div>

  <!-- LOADING SCREEN -->
  <div id="screen-loading" class="screen">
    <div class="loader-eye">
      <div class="loader-rings">
        <div class="loader-ring"></div>
        <div class="loader-ring"></div>
        <div class="loader-ring"></div>
      </div>
      <div class="loader-oval"></div>
      <div class="loader-pupil"></div>
    </div>
    <div>
      <div class="loading-title">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –æ—Ç–≤–µ—Ç—ã</div>
      <div class="loading-sub">–°–æ–ø–æ—Å—Ç–∞–≤–ª—è—é –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ñ–æ—Ä–º–∏—Ä—É—é —Ç–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç</div>
    </div>
    <div class="loading-steps" id="loadingSteps">
      <div class="loading-step active" id="step1">
        <div class="step-dot"></div><span>–°—á–∏—Ç—ã–≤–∞—é –ø–∞—Ç—Ç–µ—Ä–Ω—ã</span>
      </div>
      <div class="loading-step" id="step2">
        <div class="step-dot"></div><span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–æ—Ñ–∏–ª—å</span>
      </div>
      <div class="loading-step" id="step3">
        <div class="step-dot"></div><span>–§–æ—Ä–º–∏—Ä—É—é –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ</span>
      </div>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div id="screen-result" class="screen">
    <div class="result-label">–¢–≤–æ—ë –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ</div>
    <div class="result-title" id="resultTitle">–ü–æ—Ä—Ç—Ä–µ—Ç –≥–æ—Ç–æ–≤</div>
    <div class="result-card">
      <div class="result-text" id="resultText"></div>
    </div>
    <div class="result-tags" id="resultTags"></div>
    <button class="btn-done" onclick="closeApp()">–ì–æ—Ç–æ–≤–æ</button>
    <div class="result-footer">–≠—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –ø—É—Ç–∏. –°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç –æ—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏.</div>
  </div>

</div>

<script>
  // ‚îÄ‚îÄ Telegram WebApp init ‚îÄ‚îÄ
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#F8F8FA');
    tg.setBackgroundColor('#F8F8FA');
  }

  const API_URL = 'https://mirror-app-production.up.railway.app';

  let questions = [];
  let answers = [];
  let currentQ = 0;
  let selectedOption = null;
  const urlParams = new URLSearchParams(window.location.search);
  let testSlug = urlParams.get('test') || 'mirror-v1';
  let sessionId = null;
  let userId = tg?.initDataUnsafe?.user?.id || urlParams.get('user_id') || 123;

  // ‚îÄ‚îÄ Screens ‚îÄ‚îÄ
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + id).classList.add('active');
  }

  // ‚îÄ‚îÄ Start ‚îÄ‚îÄ
  async function startTest() {
    showScreen('loading');
    animateLoadingSteps([1,2], 900);
    try {
      const r = await fetch(`${API_URL}/test/${testSlug}`);
      const data = await r.json();
      questions = data.questions || [];
      testSlug = data.test?.slug || testSlug;

      const sr = await fetch(`${API_URL}/session/start?test_slug=${testSlug}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ telegram_id: userId, username: tg?.initDataUnsafe?.user?.username || null, first_name: tg?.initDataUnsafe?.user?.first_name || 'User' })
      });
      const sd = await sr.json();
      sessionId = sd.session_id;

      currentQ = 0;
      answers = [];
      renderQuestion();
      showScreen('question');
    } catch(e) {
      showScreen('welcome');
      console.error(e);
    }
  }

  // ‚îÄ‚îÄ Render question ‚îÄ‚îÄ
  function renderQuestion() {
    const q = questions[currentQ];
    const pct = (currentQ / questions.length) * 100;

    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('qCounter').textContent = `–í–æ–ø—Ä–æ—Å ${currentQ + 1} –∏–∑ ${questions.length}`;
    document.getElementById('qText').textContent = q.text;

    const list = document.getElementById('optionsList');
    list.innerHTML = '';
    selectedOption = null;

    const btnNext = document.getElementById('btnNext');
    btnNext.classList.remove('visible');

    q.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.textContent = opt.text;
      btn.onclick = () => selectOption(opt.id, btn);
      list.appendChild(btn);
    });
  }

  function selectOption(id, btn) {
    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedOption = id;
    document.getElementById('btnNext').classList.add('visible');
  }

  function nextQuestion() {
    if (!selectedOption) return;
    answers.push({ question_id: questions[currentQ].id, option_id: selectedOption });
    currentQ++;

    if (currentQ < questions.length) {
      renderQuestion();
    } else {
      submitAnswers();
    }
  }

  // ‚îÄ‚îÄ Submit ‚îÄ‚îÄ
  async function submitAnswers() {
    showScreen('loading');
    animateLoadingSteps([1,2,3], 1200);

    try {
      const r = await fetch(`${API_URL}/submit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          session_id: sessionId,
          user: { telegram_id: userId, username: tg?.initDataUnsafe?.user?.username || null, first_name: tg?.initDataUnsafe?.user?.first_name || 'User' },
          test_slug: testSlug,
          answers: Object.fromEntries(answers.map(a => [a.question_id, a.option_id]))
        })
      });
      const data = await r.json();

      await new Promise(res => setTimeout(res, 3200));

      try {
        showResult(data);
      } catch(renderErr) {
        showScreen('result');
        document.getElementById('resultTitle').textContent = '–ü–æ—Ä—Ç—Ä–µ—Ç –≥–æ—Ç–æ–≤';
        // Fallback: show raw text if parsing fails
        const raw = data.user_result || data.for_user || {};
        const text = typeof raw === 'object' ? (raw.full_text || raw.short_summary || JSON.stringify(raw).slice(0,200)) : String(raw);
        document.getElementById('resultText').textContent = text;
      }
    } catch(e) {
      showScreen('result');
      document.getElementById('resultText').innerHTML =
        `<div class="error-card"><p>–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${e.message}</p></div>`;
    }
  }

  function showResult(data) {
    const raw = data.user_result || data.for_user || {};
    const forUser = typeof raw === 'string' ? JSON.parse(raw) : raw;
    const crmData = data.crm_result || data.for_crm || {};

    // Show title
    const title = forUser.title || '–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç';
    document.getElementById('resultTitle').textContent = title;

    // Show full text with paragraphs
    const fullText = forUser.full_text || forUser.short_summary || '';
    const resultTextEl = document.getElementById('resultText');
    resultTextEl.innerHTML = '';
    fullText.split('\n\n').forEach(para => {
      if (para.trim()) {
        const p = document.createElement('p');
        p.style.marginBottom = '16px';
        p.textContent = para.trim();
        resultTextEl.appendChild(p);
      }
    });

    // Show strength and blindspot
    if (forUser.strength || forUser.blindspot) {
      const extras = document.createElement('div');
      extras.style.cssText = 'margin-top:20px;padding-top:16px;border-top:1px solid rgba(0,0,0,0.08);';
      if (forUser.strength) {
        const s = document.createElement('p');
        s.style.cssText = 'font-size:13px;color:#2FB7EB;margin-bottom:8px;';
        s.textContent = 'üí™ ' + forUser.strength;
        extras.appendChild(s);
      }
      if (forUser.blindspot) {
        const b = document.createElement('p');
        b.style.cssText = 'font-size:13px;color:#854999;';
        b.textContent = 'üîç ' + forUser.blindspot;
        extras.appendChild(b);
      }
      resultTextEl.appendChild(extras);
    }

    // Tags
    const tags = document.getElementById('resultTags');
    tags.innerHTML = '';
    const colors = ['blue','teal','purple','red'];
    const items = [
      crmData.vakd_primary || crmData.vak_type, crmData.archetype_light, crmData.stress_response, crmData.motivation_core
    ].filter(Boolean);

    items.slice(0,6).forEach((tag, i) => {
      const el = document.createElement('span');
      el.className = `tag tag-${colors[i % colors.length]}`;
      el.textContent = tag;
      tags.appendChild(el);
    });

    showScreen('result');
  }

  function closeApp() {
    if (tg) tg.close();
  }

  // ‚îÄ‚îÄ Loading animation ‚îÄ‚îÄ
  function animateLoadingSteps(steps, delay) {
    steps.forEach((s, i) => {
      setTimeout(() => {
        document.querySelectorAll('.loading-step').forEach(el => el.classList.remove('active'));
        if (i > 0) document.getElementById(`step${steps[i-1]}`).classList.add('done');
        document.getElementById(`step${s}`).classList.add('active');
      }, i * delay);
    });
  }
</script>
</body>
</html>
